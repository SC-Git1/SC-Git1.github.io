<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title> Module 3 | SNP calling</title>
    <meta name="author" content="Sophie Colette">
    <meta name="description" content="Module 3: SNP calling - from fastq to vcf">
    <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website">
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous">
    <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css">
    <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">
    <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light">
    <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20
																xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;">
    <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e">
    <link rel="canonical" href="https://sc-git1.github.io/blog/2021/distill/">
    <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark">
    <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script>
    <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
    <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script type="text/javascript">
      window.MathJax = {
        tex: {
          tags: "ams"
        }
      };
    </script>
    <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
    <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="/assets/js/distillpub/template.v2.js"></script>
    <script src="/assets/js/distillpub/transforms.v2.js"></script>
    <script src="/assets/js/distillpub/overrides.js"></script>
    <style>
      p {
        text-align: justify;
        margin-bottom: 0;
      }
    </style>
    <style type="text/css">
      .fake-img {
        background: #bbb;
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 12px
      }

      .fake-img p {
        font-family: monospace;
        color: white;
        text-align: left;
        margin: 12px 0;
        text-align: center;
        font-size: 16px
      }
    </style>
  </head>
  <body>
    <header>
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="/">
            <span class="font-weight-bold">Workshop </span>SNP Calling on the VSC </a>
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>
          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/workshop/">workshop</a>
              </li>
              <li class="toggle-container">
                <button id="light-toggle" title="Change theme">
                  <i class="fa-solid fa-moon"></i>
                  <i class="fa-solid fa-sun"></i>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <progress id="progress" value="0">
        <div class="progress-container">
          <span class="progress-bar"></span>
        </div>
      </progress>
    </header>
    <div class="post distill">
      <d-title>
        <h1>Module 3: SNP calling - part 1</h1>
        <p>From fastq to vcf</p>
      </d-title>
      <d-article>
        <d-contents>
          <nav class="l-text figcaption">
            <h3>Contents</h3>
            <div>
              <a href="Data">Data</a>
            </div>
            <div>
              <a href="Create the Conda environment">Create the Conda environment</a>
            </div>
            <div>
              <a href="Data">Data</a>
            </div>
          </nav>
        </d-contents>
        <style>
          p {
            text-align: justify;
          }
        </style>
        <h2 id="Data">Input data</h2>
        <p>In this workshop, we will run a SNP calling workflow on short read data produced on an Illumina GAIIx from exome-enriched DNA of chromosome 22 of a single human individual. THe data was generated as part of the 1000 genomes Genomes project. The dataset consists of one million 76bp reads. The data can be downloaded <a href="https://swift.rc.nectar.org.au:8888/v1/AUTH_a3929895f9e94089ad042c9900e1ee82/VariantDet_BASIC/NA12878.GAIIx.exome_chr22.1E6reads.76bp.fastq" target="_blank">here</a>. The reference genome of chromosome 22 of version h38 (latest major human genome release) can be downloaded at the bottom of this page: <a href="https://hgdownload.soe.ucsc.edu/goldenPath/hg38/chromosomes/" target="_blank">https://hgdownload.soe.ucsc.edu/goldenPath/hg38/chromosomes/</a>. Upload the files to the VSC, decompress the reference h38.fa by using the gunzip tool, and rename it to h38_22.fa to avoid confusion. </p>
        <h2 id="Create the Conda environment">Create the Conda environment</h2>
        <p>The following packages need to be installed: fastqc, bwa-mem2, samtools, bcftools, matplotlib, vt, and snpeff. First, create a new conda environment:
        <div class="language-plaintext highlighter-rouge">
          <div class="highlight">
            <pre class="highlight"><code><span>conda create --name ws_snp_calling</span></code></pre>
          </div>
        </div> Next, activate the environment: <div class="language-plaintext highlighter-rouge">
          <div class="highlight">
            <pre class="highlight"><code><span>conda activate ws_snp_calling</span></code></pre>
          </div>
        </div> Finally, install the required packages: <div class="language-plaintext highlighter-rouge">
          <div class="highlight">
            <pre class="highlight"><code><span>conda install bioconda::fastqc bioconda::bwa-mem2 bioconda::samtools bioconda::bcftools conda-forge::matplotlib bioconda::vt bioconda::snpeff</span></code>
				</pre>
          </div>
        </div> Alternatively, you can add the Conda environment by downloading the <a href="/workshop/3_SNP_Calling_from_fastq_to_vcf/ws_snp_calling.yml" download>ws_snp_calling.yml file</a> file, uploading it to the VSC and running: <div class="language-plaintext highlighter-rouge">
          <div class="highlight">
            <pre class="highlight"><code><span>conda env create --name ws_snp_calling -f ws_snp_calling.yml</span></code></pre>
          </div>
        </div> Don't forget to activate the Conda environment: <div class="language-plaintext highlighter-rouge">
          <div class="highlight">
            <pre class="highlight"><code><span>conda activate ws_snp_calling.yml</span></code></pre>
          </div>
        </div>
        </p>
        <h2 id="fastqc">fastqc</h2>
        <p>In this paragraph we will run a QC analysis on the fastq file. The first step is to inspect the file content. This is important as incomplete data transfer can happen when downloading a file. In a first step, we inspect the head of the file:
        <div class="language-plaintext highlighter-rouge">
          <div class="highlight">
            <pre class="highlight"><code><span>head NA12878.GAIIx.exome_chr22.1E6reads.76bp.fastq</span></code></pre>
          </div>
        </div>
        <figure>
          <picture>
            <source class="responsive-img-srcset" srcset=" //assets/img/head_fastq-480.webp 480w, /assets/img/head_fastq-800.webp 800w, /assets/img/head_fastq-1400.webp 1400w, " sizes="95vw" type="image/webp">
            </source>
            <img src="/assets/img/head_fastq.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();">
          </picture>
        </figure>
        <div class="caption">Output of head NA12878.GAIIx.exome_chr22.1E6reads.76bp.fastq</div> What does a file in the fastq format normally look like? Every read in a fastq file consists of 4 lines, also called 'fields'. </p>
        <ul>
          <li>
            <strong>Field 1</strong>: begins with the "@" character and contains the sequnce id, optionally followed by a description
          </li>
          <li>
            <strong>Field 2</strong>: the nucleotide sequence
          </li>
          <li>
            <strong>Field 3</strong>: begins with the "+" character, optionally follwed by the content of Field 1
          </li>
          <li>
            <strong>Field 4</strong>: contains encoded quality values for each position in the nucleotide sequence
          </li>
        </ul>
        <p>Similarly, the tail of the fastq file should end with Field 4 of the last read i.e., end with a complete read.</p>
        <figure>
          <picture>
            <source class="responsive-img-srcset" srcset=" //assets/img/head_fastq-480.webp 480w, /assets/img/head_fastq-800.webp 800w, /assets/img/head_fastq-1400.webp 1400w, " sizes="95vw" type="image/webp">
            </source>
            <img src="/assets/img/head_fastq.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();">
          </picture>
        </figure>
        <div class="caption">Output of tail NA12878.GAIIx.exome_chr22.1E6reads.76bp.fastq</div>
        <p>You can also check if the number of lines in the fastq file divided by 4 is equal to an integer.</p>
        <div class="language-plaintext highlighter-rouge">
          <div class="highlight">
            <pre class="highlight"><code><span># Number of reads, should output: 1151702</span>
<span>wc -l NA12878.GAIIx.exome_chr22.1E6reads.76bp.fastq | awk '{x=$1/4; print x}'</span>
<span># Or equivalently, check if the remainder is equal to zero</span>
<span>wc -l NA12878.GAIIx.exome_chr22.1E6reads.76bp.fastq | awk '{x=$1%4; print x}'</span></code>
																									</pre>
          </div>
        </div>
        <p>This list is not exhaustive. You can come up with additional checks for your fastq file. For example, you can check whether the sequence in Field 2 and the quality scores in Field 4 of the same length. When you share a file or upload it to a server like the VSC, you can also check if the files before and after transfer are identical by generating checksums with a program like md5sum. If there are issues with the fastq file, try to download it again, or contact the provider of the original file to report the issue. </p>
        <p> After you controlled the validity of the fastq file, you can run the program fastqc to check the quality of the reads. For this, first create an directory for the output data:
        <div class="language-plaintext highlighter-rouge">
          <div class="highlight">
            <pre class="highlight"><code><span>mkdir -p fastqc_output</span></code></pre>
          </div>
        </div> and then run: <div class="language-plaintext highlighter-rouge">
          <div class="highlight">
            <pre class="highlight"><code><span>fastqc fastq_input_data/NA12878.GAIIx.exome_chr22.1E6reads.76bp.fastq -o fastqc_output</span></code>
				</pre>
          </div>
        </div>
        </p> Have a look at the list of files written to the output folder: <div class="language-plaintext highlighter-rouge">
          <div class="highlight">
            <pre class="highlight"><code><span>ls -lah ./fastqc_output</span></code></pre>
          </div>
        </div>
        <p>There should be two files in the output directory: a .zip file and a .html file. Download the .html file and open it in your browser. The .html file contains the FastQC report. The quality is measured by 10 statistics. The outcome is labeled in green (= pass), orange ("warning") or red ("error"). Images of the plots can be found in the .zip file, both in the PNG and SVG format. The FastQC report generated here contains 1 error and three warnings. However, note that a warning or an error does not necessarily mean that your data is of poor quality. Some statistics are expected to deviate based on the experiment you performed. It is therefore advised to always look up what the statistic means (within the context of your experiment) and the potential causes of the warning/error. In the next subparagraphs, we will go over all statistics and briefly explain how to interpret them.
         For more information we refer to the FastQC manual[TODO: REFERENCE!].
        </p>
        <h3>Basic statistics</h3>
        <figure>
          <picture>
            <source class="responsive-img-srcset" srcset=" //assets/img/stat1-480.webp 480w, /assets/img/stat1-800.webp 800w, /assets/img/stat1-1400.webp 1400w, " sizes="95vw" type="image/webp">
            </source>
            <img src="/assets/img/stat1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();">
          </picture>
        </figure>
        <p>The basic statistics section never raises an error or warning, but informs you about some properties of the file:</p>
        <ul>
          <li>
            <strong>Filename</strong>
          </li>
          <li>
            <strong>File type</strong>
          </li>
          <li>
            <strong>Encoding</strong>: guess of the data format used, indicates the type of quality score (Field 4).
          </li> 
          <blockquote class="block-warning"> <h5 id="warning">WARNING</h5> 
            <p>
               The reported encoding is only a guess made by FastQC and can thus be wrong. 
               This happens primarly when the quality of your reads is overall of very good quality.
               Therefore, always check if the encoding is what you expected, as this has a large influence on the plot.
            </p>
          </blockquote>
          <p>
            The three possible quality score types are: Solexa+64, Phred+64 and Phred+33. 
            Some examples of data formats and their associated type are given in the table below.
          </p>
          <style>
            td,
            th {
              padding-top: 1%;
              padding-bottom: 1%;
              padding-left: 1%;
              padding-right: 1%;
            }

            td:nth-child(2) {
              text-align: justify;
              width: 60%;
            }

            td:nth-child(1) {
              width: 20%;
            }

            td:first-child,
            td:last-child {
              text-align: center;
            }
          </style>
          <table class="table" border=1px>
            <tr>
              <th>Encoding</th>
              <th>Quality score type</th>
            </tr>
            <tr>
              <td>Sanger / Illumina 1.8+</td>
              <td>Phred+33</td>
            </tr>
            <tr>
              <td>Sanger / Illumina 1.5</td>
              <td>Phred+64</td>
            </tr>
            <tr>
              <td>Sanger / Illumina 1.3</td>
              <td>Phred+64</td>
            </tr>
            <tr>
              <td>Solexa / Illumina</td>
              <td>Solexa+64</td>
            </tr>
          </table>
          <p>The type needs to be specified in tools like Trimmomatic (a read trimming tool for Illumina NGS data) and Bowtie2 (a reference alignment tool for short reads (50-100 bp)). Other tools only support one format, for example the reference algment tool "bwa-mem" only supports Phred+33 [reference:https://sourceforge.net/p/bio-bwa/mailman/bio-bwa-help/thread/CAF%2BL%2BTeKa9v0Nmjrn-DS9QKzsyTjAEcFyXMNkw-ygzLkdXo4AQ%40mail.gmail.com/#msg31652789]. Using Phred+64 files in a Phred+33 pipeline results in an incorrect interpretation of the quality score i.e., the quality is overestimated. Phred+33 is the standard in the newest Illumina versions, and the most widely supported format. To convert your fastq file to Phred+33, you can use for example the "FastQ Groomer" tool of Galaxy. </p>
          <li>
            <strong>Total sequences</strong>: Total number of sequences processed. It is good practice to keep track of the total number of reads throughout the analysis.
          </li>
          <li>
            <strong>Total bases</strong>: Total number of sequences processed.
          </li>
          <li>
            <strong>Sequences flagged as poor quality</strong>Sequences flagged as poor quality
          </li>
          <li>
            <strong>Sequence length</strong>: provides the length of the shortest and longest sequence. Returns one value if those are equal.
          </li>
          <li>
            <strong>%GC</strong>
          </li>
          <p>A question to ask yourself is: are the sequence length and %GC as expected?</p>
        </ul>
        <h3>Per base sequence quality</h3>
        <figure>
         <picture>
           <source class="responsive-img-srcset" srcset=" //assets/img/stat1-480.webp 480w, /assets/img/stat1-800.webp 800w, /assets/img/stat1-1400.webp 1400w, " sizes="95vw" type="image/webp">
           </source>
           <img src="/assets/img/stat1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();">
         </picture>
        </figure>
        <p>The "per base sequence quality" plot is the most important analysis in the FastQC report. It shows the distribution of the quality score over all reads per position. The expected output 
            depends on the sequencing platform used. For example, in the case of sequencing-by-synthesis, the quality of calls degrade toward the end of the reads due to signal decay and phasing (= blurring of the signal due to loss of synchronicity within the clusters) towards the end of the run.
            The distribution of quality scores is represented by a whisker plot. The different aspects of the distribution and their visualisation are:
            <ul>
               <li><strong>Median</strong>: red line</li>
               <li><strong>Inter-quartile range (25-75%)</strong>: yellow box</li>
               <li><strong>10% threshold</strong>: lower whisker</li>
               <li><strong>90% threshold</strong>: upper whisker</li>
               <li><strong>Mean</strong>: blue line</li>
            </ul>
            The y-axis is split into 3 quality categories:
            <table class="table" border=1px>
               <tr>
                 <th>Quality</th>
                 <th>Color code</th>
               </tr>
               <tr>
                 <td>very good quality calls</td>
                 <td>green</td>
               </tr>
               <tr>
                 <td>reasonable quality calls</td>
                 <td>orange</td>
               </tr>
               <tr>
                  <td>poor quality</td>
                  <td>red</td>
                </tr>
             </table>
        </p>
        The quality scores are calculated using the following formula:
        [-10 \log_{10}(e)] 

        <blockquote class="block-tip"> <h5 id="Tip">TIP</h5> 
         <p>
            If the quality drops singificantly towards the end, you might consider trimming the reads by position, or based on quality.
         </p>
        </blockquote>
        <p>In the case of Illumina seqeuncing, frequenlty occurring probelms and their quality trend, are given in the table below.
            <table class="table" border=1px>
               <tr>
                 <th>Trend</th>
                 <th>Cause</th>
               </tr>
               <tr>
                 <td>Lower quality scores across the <strong>entire read</strong></td>
                 <td>Overclustering leading to overlapping signals</td>
               </tr>
               <tr>
                 <td>Sudden drops in signal or high % of poor quality reads</td>
                 <td>Instrumentation breakdown (e.g., cycles lost)</td>
               </tr>
             </table>
        </p>
        <h3>Per tile sequence quality</h3>
        <p>The "per tile sequence quality" plot only appears in the presence of an Illumina library and the original sequence identifiers 
         (which contain the flowcell tile for each read). This plot shows the deviation from the average quality for each combination of flowcell tile (y-axis) and position (x-axis).
         The colors range from blue (good) to red (worse). A good plot is entirely blue.
        </p>
        <h3>Per sequence quality scores</h3>
        <h3>Per base sequence content</h3>
        <h3>Per sequence GC content</h3>
        <h3>Per base N content</h3>
        <h3>Sequence length distribution</h3>
        <h3>Sequence duplication levels</h3>
        <h3>Overrepresented sequences</h3>
        <h3>Adapter content</h3>
        <li>
          <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/workshop/5_project/">Module 5: SNP calling - part 2</a>
        </li>
      </d-article>
      <d-appendix>
        <d-citation-list>
         <p>https://training.galaxyproject.org/training-material/topics/sequence-analysis/tutorials/quality-control/tutorial.html</p>
        </d-citation-list>
      </d-appendix>
      <d-bibliography src="/assets/bibliography/2018-12-22-distill.bib"></d-bibliography>
    </div>
    <footer class="fixed-bottom">
      <div class="container mt-0"> Â© Copyright 2023 Sophie Colette. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div>
    </footer>
    <script src="/assets/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>
    <script type="text/javascript">
      function progressBarSetup() {
        "max" in document.createElement("progress") ? (initializeProgressElement(), $(document).on("scroll", function() {
          progressBar.attr({
            value: getCurrentScrollPosition()
          })
        }), $(window).on("resize", initializeProgressElement)) : (resizeProgressBar(), $(document).on("scroll", resizeProgressBar), $(window).on("resize", resizeProgressBar))
      }

      function getCurrentScrollPosition() {
        return $(window).scrollTop()
      }

      function initializeProgressElement() {
        let e = $("#navbar").outerHeight(!0);
        $("body").css({
          "padding-top": e
        }), $("progress-container").css({
          "padding-top": e
        }), progressBar.css({
          top: e
        }), progressBar.attr({
          max: getDistanceToScroll(),
          value: getCurrentScrollPosition()
        })
      }

      function getDistanceToScroll() {
        return $(document).height() - $(window).height()
      }

      function resizeProgressBar() {
        progressBar.css({
          width: getWidthPercentage() + "%"
        })
      }

      function getWidthPercentage() {
        return getCurrentScrollPosition() / getDistanceToScroll() * 100
      }
      const progressBar = $("#progress");
      window.onload = function() {
        setTimeout(progressBarSetup, 50)
      };
    </script>
  </body>
</html>